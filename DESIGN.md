# Socrates アプリ 設計要約

## 概要

**Socrates**は、LLM（大規模言語モデル）を使用した一対一のディベートバトルアプリです。ユーザーはランダムまたは選択されたトピックに基づき、議論を行い、その議論を AI が評価してより優れた意見を持っている方を判定します。議論の楽しさと深い語り合いを世界中に広めることを目的とします。

## 技術スタック

- **フロントエンド**: Next.js, TypeScript, TailwindCSS
- **バックエンド**: FastAPI
- **データベース & ストレージ**: Firestore, Firebase Storage
- **認証**: Firebase Authentication
- **インフラストラクチャ**: Cloud Run

## Firestore セキュリティルール

- **認証済みユーザー**のみが自分の情報に対して CRUD 操作が可能です。
- **プロフィール**は公開読み取り可能で、所有者のみが更新可能です。
- **セッション（ディベートとチャット）**: 参加者のみがアクセス可能です。チャットは、セッション作成者が公開または非公開を選択できます。

## チャットの公開性設定

- カスタムマッチやルームマッチの際、チャットを公開または非公開に設定できるオプションを提供します。
- **公開設定**: 参加者以外のユーザーもチャット内容を閲覧できます。
- **非公開設定**: チャット内容は参加者のみが閲覧可能です。

## API 設計

### マッチング関連

- `/api/match/random`: ランダムマッチングを行います。
- `/api/match/custom`: カスタムマッチングを行います。チャットの公開/非公開設定含む。

### ランダムマッチング

#### バックエンド

1. ユーザーがランダムマッチングを選択すると、そのユーザーの`user_id`が Firestore の`waiting_list`コレクションに追加されます。
2. 同時に、そのユーザーの`user_id`を含めて他に`waiting_list`にいるユーザーがいる場合は、マッチングを作成します。
3. マッチングが作成されたら、両ユーザーの情報で新しいディベートセッションを生成し、そのセッション ID を含めた情報を両ユーザーに通知します。
4. 両方のユーザーを`waiting_list`から削除します。

#### フロントエンド

1. ユーザーが「ランダムマッチング開始」をクリックすると、その`user_id`が`waiting_list`に送信されます。
2. フロントエンドはリアルタイムで`waiting_list`の変更を監視し、自分の`user_id`ともう一人のユーザーがリストに存在することを確認します。
3. マッチングが成立したら（つまり、自分以外の`user_id`がリストに存在したら）、フロントエンドはマッチング通知と共にディベートルーム（セッション ID に基づく）に自動的に移動します。
4. `waiting_list`で自分だけの場合は、マッチング待ちの状態を表示し、他のユーザーの参加を待ちます。

### ルームマッチング

ルームマッチングでは、特定のグループやトピックに関心があるユーザー同士でマッチングします。

#### バックエンド

1. ユーザーがルームマッチングを選択し、ルーム ID もしくはルームに関する情報を指定します。
2. この情報に基づき、対応するルームの`waiting_list`にユーザーの`user_id`を追加します。
3. ルームの`waiting_list`を監視し、特定数（ここでは 2 人）のユーザーが揃ったら、ディベートセッションを生成し、参加者に通知します。
4. 生成されたセッション情報を用いて、マッチングされたユーザーを対応するルームに案内します。

#### フロントエンド

1. ユーザーが特定のルームでのマッチングを選択すると、その情報がバックエンドに送信され、`waiting_list`に追加されます。
2. フロントエンドはリアルタイムでルームの`waiting_list`を監視し、適切な人数が揃ったことを確認します。
3. マッチングが成立し、ディベートセッションが生成されたら、ユーザーは自動的に該当セッションのディベートルームに移動します。
4. 各ルームのマッチング待ち状態を監視し、適切にユーザーに情報を表示します。

### ディベート関連

- `/api/debate/start`: 新しいディベートセッションを開始します。
- `/api/debate/submit_response`: ディベート中の発言を提出します。
- `/api/debate/judge`: ディベートの終了時に、勝者を判定します。

## フロントエンドの主要ページ

- **ホームページ**: アプリの概要と主な機能紹介。
- **登録/ログインページ**: ユーザー登録とログイン。
- **マッチメイキングページ**: マッチタイプ選択。公開/非公開チャット設定。
- **ディベート/チャットページ**: ディベート実施、チャット機能。
- **プロファイルページ**: ユーザー情報、ディベート履歴。
- **フィードバックページ**: ユーザーフィードバック送信。
